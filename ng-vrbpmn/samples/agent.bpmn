<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="Defs_ContextManagedAgent" targetNamespace="https://example.com/bpmn/context-managed-agent" exporter="bpmn-js (https://demo.bpmn.io)" exporterVersion="18.10.1">
  <bpmn:collaboration id="Collab_1">
    <bpmn:participant id="Participant_Agent" name="Context-managed agent" processRef="Process_Agent" />
  </bpmn:collaboration>
  <bpmn:process id="Process_Agent" name="Short Context + Long/Short-term Memory Loop" isExecutable="false">
    <bpmn:startEvent id="Start_Message" name="User message received" />
    <bpmn:task id="Task_Parse" name="Parse intent" />
    <bpmn:task id="Task_LoadState" name="Load structured state (state.json)" />
    <bpmn:task id="Task_Preflight" name="Preflight (env/tools)" />
    <bpmn:task id="Task_Retrieve" name="Retrieve relevant memory" />
    <bpmn:task id="Task_Budget" name="Allocate context budget" />
    <bpmn:task id="Task_Assemble" name="Assemble short prompt" />
    <bpmn:task id="Task_ExecTool" name="Execute tool" />
    <bpmn:task id="Task_LogResult" name="Store tool output as artifact (short-term)" />
    <bpmn:endEvent id="End_Done" name="Done" />
    <bpmn:task id="Task_Respond" name="Respond (minimal necessary context)" />
    <bpmn:task id="Task_Persist" name="Persist state + memory pointers" />
    <bpmn:task id="Task_Compact" name="Compaction snapshot (summary + pointers)" />
    <bpmn:exclusiveGateway id="Gw_Compact" name="Compact now?" />
    <bpmn:exclusiveGateway id="Gw_ToolCall" name="Tool call requested?" />
    <bpmn:task id="Task_UpdateWS" name="Update working set (plan/next)" />
    <bpmn:task id="Task_CallLLM" name="Call LLM" />
    <bpmn:sequenceFlow id="Flow_1" sourceRef="Start_Message" targetRef="Task_Parse" />
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_Parse" targetRef="Task_LoadState" />
    <bpmn:sequenceFlow id="Flow_3" sourceRef="Task_LoadState" targetRef="Task_Preflight" />
    <bpmn:sequenceFlow id="Flow_4" sourceRef="Task_Preflight" targetRef="Task_Retrieve" />
    <bpmn:sequenceFlow id="Flow_5" sourceRef="Task_Retrieve" targetRef="Task_Budget" />
    <bpmn:sequenceFlow id="Flow_11" sourceRef="Task_LogResult" targetRef="Task_Budget" />
    <bpmn:sequenceFlow id="Flow_6" sourceRef="Task_Budget" targetRef="Task_Assemble" />
    <bpmn:sequenceFlow id="Flow_7" sourceRef="Task_Assemble" targetRef="Task_CallLLM" />
    <bpmn:sequenceFlow id="Flow_9_yes" sourceRef="Gw_ToolCall" targetRef="Task_ExecTool">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">yes</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_10" sourceRef="Task_ExecTool" targetRef="Task_LogResult" />
    <bpmn:sequenceFlow id="Flow_16" sourceRef="Task_Respond" targetRef="End_Done" />
    <bpmn:sequenceFlow id="Flow_15" sourceRef="Task_Persist" targetRef="Task_Respond" />
    <bpmn:sequenceFlow id="Flow_13_no" sourceRef="Gw_Compact" targetRef="Task_Respond">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">no</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_14" sourceRef="Task_Compact" targetRef="Task_Persist" />
    <bpmn:sequenceFlow id="Flow_13_yes" sourceRef="Gw_Compact" targetRef="Task_Compact">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">yes</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_12" sourceRef="Task_UpdateWS" targetRef="Gw_Compact" />
    <bpmn:sequenceFlow id="Flow_8" sourceRef="Task_CallLLM" targetRef="Gw_ToolCall" />
    <bpmn:sequenceFlow id="Flow_9_no" sourceRef="Gw_ToolCall" targetRef="Task_UpdateWS">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">no</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="Diagram_1">
    <bpmndi:BPMNPlane id="Plane_1" bpmnElement="Collab_1">
      <bpmndi:BPMNShape id="Shape_Participant_Agent" bpmnElement="Participant_Agent" isHorizontal="true">
        <dc:Bounds x="160" y="80" width="1770" height="520" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Start" bpmnElement="Start_Message">
        <dc:Bounds x="220" y="185" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="203" y="221" width="71" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Parse" bpmnElement="Task_Parse">
        <dc:Bounds x="300" y="165" width="120" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_LoadState" bpmnElement="Task_LoadState">
        <dc:Bounds x="460" y="165" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Preflight" bpmnElement="Task_Preflight">
        <dc:Bounds x="660" y="165" width="150" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Retrieve" bpmnElement="Task_Retrieve">
        <dc:Bounds x="850" y="165" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Budget" bpmnElement="Task_Budget">
        <dc:Bounds x="1050" y="165" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Assemble" bpmnElement="Task_Assemble">
        <dc:Bounds x="1250" y="165" width="160" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_ExecTool" bpmnElement="Task_ExecTool">
        <dc:Bounds x="1480" y="265" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_LogResult" bpmnElement="Task_LogResult">
        <dc:Bounds x="1250" y="265" width="140" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_End" bpmnElement="End_Done">
        <dc:Bounds x="220" y="482" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="225" y="518" width="27" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Respond" bpmnElement="Task_Respond">
        <dc:Bounds x="300" y="470" width="160" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Persist" bpmnElement="Task_Persist">
        <dc:Bounds x="300" y="380" width="160" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_Compact" bpmnElement="Task_Compact">
        <dc:Bounds x="970" y="380" width="160" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_GwCompact" bpmnElement="Gw_Compact" isMarkerVisible="true">
        <dc:Bounds x="1545" y="385" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1533" y="361" width="74" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_GwTool" bpmnElement="Gw_ToolCall" isMarkerVisible="true">
        <dc:Bounds x="1735" y="270" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1795" y="281" width="56" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_UpdateWS" bpmnElement="Task_UpdateWS">
        <dc:Bounds x="1700" y="380" width="120" height="60" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Shape_CallLLM" bpmnElement="Task_CallLLM">
        <dc:Bounds x="1485" y="163" width="110" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Edge_Flow_1" bpmnElement="Flow_1">
        <di:waypoint x="256" y="203" />
        <di:waypoint x="300" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_2" bpmnElement="Flow_2">
        <di:waypoint x="420" y="205" />
        <di:waypoint x="460" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_3" bpmnElement="Flow_3">
        <di:waypoint x="620" y="205" />
        <di:waypoint x="660" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_4" bpmnElement="Flow_4">
        <di:waypoint x="810" y="205" />
        <di:waypoint x="850" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_5" bpmnElement="Flow_5">
        <di:waypoint x="1010" y="205" />
        <di:waypoint x="1050" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_6" bpmnElement="Flow_6">
        <di:waypoint x="1210" y="205" />
        <di:waypoint x="1250" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_7" bpmnElement="Flow_7">
        <di:waypoint x="1410" y="205" />
        <di:waypoint x="1485" y="205" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_8" bpmnElement="Flow_8">
        <di:waypoint x="1595" y="203" />
        <di:waypoint x="1760" y="203" />
        <di:waypoint x="1760" y="270" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_9_yes" bpmnElement="Flow_9_yes">
        <di:waypoint x="1735" y="295" />
        <di:waypoint x="1600" y="295" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_10" bpmnElement="Flow_10">
        <di:waypoint x="1480" y="295" />
        <di:waypoint x="1390" y="295" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_11" bpmnElement="Flow_11">
        <di:waypoint x="1250" y="295" />
        <di:waypoint x="1130" y="295" />
        <di:waypoint x="1130" y="245" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_9_no" bpmnElement="Flow_9_no">
        <di:waypoint x="1760" y="320" />
        <di:waypoint x="1760" y="380" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_12" bpmnElement="Flow_12">
        <di:waypoint x="1700" y="410" />
        <di:waypoint x="1595" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_13_yes" bpmnElement="Flow_13_yes">
        <di:waypoint x="1545" y="410" />
        <di:waypoint x="1130" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_13_no" bpmnElement="Flow_13_no">
        <di:waypoint x="1570" y="435" />
        <di:waypoint x="1570" y="500" />
        <di:waypoint x="460" y="500" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_14" bpmnElement="Flow_14">
        <di:waypoint x="970" y="410" />
        <di:waypoint x="460" y="410" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_15" bpmnElement="Flow_15">
        <di:waypoint x="380" y="440" />
        <di:waypoint x="380" y="470" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Edge_Flow_16" bpmnElement="Flow_16">
        <di:waypoint x="300" y="500" />
        <di:waypoint x="256" y="500" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
