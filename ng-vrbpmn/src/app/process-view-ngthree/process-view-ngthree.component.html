<div class="viewport-container" (window:pointerup)="onMouseUp($event)">
    <th-canvas (onPointerMove)="onMouseMove($event)" [shadowmap]="true">
        <!-- Camera & Controls -->
        <th-perspective-camera #camera
            [args]="[CAMERA_CONFIG.FOV, CAMERA_CONFIG.ASPECT, CAMERA_CONFIG.NEAR, CAMERA_CONFIG.FAR]"
            [position]="[CAMERA_CONFIG.POSITION.x, CAMERA_CONFIG.POSITION.y, CAMERA_CONFIG.POSITION.z]">
            <th-orbit-controls [enabled]="!state.draggedNodeId() && state.interactionMode() !== 'add'"
                [enableRotate]="true" [enableDamping]="true" [dampingFactor]="0.05" [minDistance]="2"
                [maxDistance]="50"></th-orbit-controls>
        </th-perspective-camera>

        <th-scene [background]="COLORS.FOG">
            <!-- Lights -->
            <th-ambient-light [color]="COLORS.AMBIENT" [intensity]="LIGHT_CONFIG.AMBIENT_INTENSITY"></th-ambient-light>
            <th-point-light [color]="COLORS.CYAN" [intensity]="LIGHT_CONFIG.POINT_LIGHT_INTENSITY" [distance]="100"
                [position]="[0, 10, 5]"></th-point-light>

            <!-- Ground Group -->
            <th-group [position]="[0, 0, 0]">
                <!-- Mirror/Ground -->
                <th-mesh name="ground" [rotation]="[-Math.PI / 2, 0, 0]" [position]="[0, -1.5, 0]"
                    (onClick)="onCanvasClick($event)">
                    <th-plane-geometry [args]="[100, 100]"></th-plane-geometry>
                    <th-mesh-standard-material [color]="COLORS.GROUND" [roughness]="1"
                        [metalness]="0"></th-mesh-standard-material>
                </th-mesh>

                <!-- Grid -->
                <th-object3d [object]="grid"></th-object3d>
            </th-group>

            <!-- Nodes -->
            <th-group *ngFor="let node of state.allNodes()" [position]="node.position"
                (onPointerOver)="state.hoverNode(node.id, true)" (onPointerOut)="state.hoverNode(node.id, false)"
                (onPointerDown)="onNodeDown($event, node.id)">

                <!-- Physical Node -->
                <th-group (onBeforeRender)="onNodeRender($event, node.id)">
                    <!-- Outer Shell -->
                    <th-mesh>
                        <th-cylinder-geometry *ngIf="isRound(node.type)"
                            [args]="[0.75, 0.75, 1.25, 32]"></th-cylinder-geometry>
                        <th-box-geometry *ngIf="!isRound(node.type)" [args]="[1.2, 1.2, 1.2]"></th-box-geometry>

                        <th-mesh-physical-material
                            [color]="(state.selectedNodeId() === node.id || state.hoveredNodeId() === node.id) ? COLORS.HIGHLIGHT : COLORS.BLACK"
                            [metalness]="0.1" [roughness]="0.4" [transmission]="0.5" [thickness]="1.0"
                            [transparent]="true"
                            [emissive]="(state.selectedNodeId() === node.id || state.hoveredNodeId() === node.id) ? COLORS.CYAN : COLORS.DARK_GRAY"
                            [emissiveIntensity]="(state.selectedNodeId() === node.id || state.hoveredNodeId() === node.id) ? 2 : 1"
                            [opacity]="0.7">
                        </th-mesh-physical-material>
                    </th-mesh>

                    <!-- Inner Icon -->
                    <th-mesh>
                        <th-sphere-geometry *ngIf="node.type === 'start'" [args]="[0.3, 24, 24]"></th-sphere-geometry>
                        <th-cylinder-geometry *ngIf="node.type === 'usertask'"
                            [args]="[0.15, 0.25, 0.5, 32]"></th-cylinder-geometry>
                        <th-box-geometry *ngIf="node.type === 'servicetask'" [args]="[0.5, 0.5, 0.5]"></th-box-geometry>
                        <th-octahedron-geometry *ngIf="node.type === 'xgateway'"
                            [args]="[0.4]"></th-octahedron-geometry>
                        <th-capsule-geometry *ngIf="node.type === 'pgateway'"
                            [args]="[0.25, 0.25, 4, 8]"></th-capsule-geometry>
                        <th-torus-geometry *ngIf="node.type === 'terminal'"
                            [args]="[0.3, 0.05, 8, 24]"></th-torus-geometry>

                        <th-mesh-standard-material [color]="COLORS.CYAN" [emissive]="COLORS.CYAN"
                            [emissiveIntensity]="10" [wireframe]="true"></th-mesh-standard-material>
                    </th-mesh>
                </th-group>

                <!-- Label -->
                <th-css2d-object [position]="[0, 1.5, 0]">
                    <div class="floating-label" (click)="onLabelClick($event, node.id)">{{node.name | uppercase}}</div>
                </th-css2d-object>
            </th-group>

            <!-- Connections -->
            <th-group *ngFor="let conn of state.allConnections()">
                <!-- Line -->
                <th-line [geometry]="getConnGeometry(conn)">
                    <th-line-basic-material [color]="COLORS.CYAN" [transparent]="true"
                        [opacity]="(state.interactionMode() === 'delete' && state.hoveredConnectionId() === conn.id) ? 1.0 : 0.5">
                    </th-line-basic-material>
                </th-line>

                <!-- Click Target -->
                <th-mesh (onPointerOver)="state.hoverConnection(conn.id, true)"
                    (onPointerOut)="state.hoverConnection(conn.id, false)" (onClick)="onConnClick($event, conn.id)">
                    <th-tube-geometry [args]="[getConnPath(conn), 20, 0.3, 8, false]"></th-tube-geometry>
                    <th-mesh-basic-material [transparent]="true" [opacity]="0"
                        [depthTest]="true"></th-mesh-basic-material>
                </th-mesh>

                <!-- Arrowhead -->
                <th-mesh [position]="getArrowPos(conn)" [quaternion]="getArrowQuat(conn)">
                    <th-cone-geometry [args]="[0.15, 0.4, 8]"></th-cone-geometry>
                    <th-mesh-standard-material [color]="COLORS.CYAN" [emissive]="COLORS.CYAN"
                        [emissiveIntensity]="2"></th-mesh-standard-material>
                </th-mesh>

                <!-- Footprints -->
                <th-mesh [position]="getFootprintPos(conn, 'source')" [rotation]="[-Math.PI / 2, 0, 0]">
                    <th-ring-geometry [args]="[0.7, 0.75, 32]"></th-ring-geometry>
                    <th-mesh-basic-material [color]="COLORS.CYAN" [transparent]="true" [opacity]="0.2"
                        [side]="THREE.DoubleSide"></th-mesh-basic-material>
                </th-mesh>
                <th-mesh [position]="getFootprintPos(conn, 'target')" [rotation]="[-Math.PI / 2, 0, 0]">
                    <th-ring-geometry [args]="[0.7, 0.75, 32]"></th-ring-geometry>
                    <th-mesh-basic-material [color]="COLORS.CYAN" [transparent]="true" [opacity]="0.2"
                        [side]="THREE.DoubleSide"></th-mesh-basic-material>
                </th-mesh>
            </th-group>

        </th-scene>
    </th-canvas>

    <!-- UI Overlay -->
    <app-ui-overlay></app-ui-overlay>
</div>